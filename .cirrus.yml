env:
    CIRRUS_CLONE_DEPTH: 1
    BUILD_HOSTNAME: "CirrusCI"
    CIRRUS_WORKING_DIR: "/tmp/ci"
    USERNAME: ""
    EMAIL: ""
    SSHKEY1: ""
    SSHKEY2: ""

task:
  name: Ubuntu Touch - Xiaomi Redmi Note 10 Pro
  container:
    image: ubuntu:20.04
    cpu: 4
    memory: 8G

  sshkey_script:
    - mkdir -p ~/.ssh && sudo chmod 700 ~/.ssh/ && sudo rm -rf /root/.ssh && git config --global --add safe.directory /tmp/ci/UBPorts && git config --global user.name "$USERNAME" && git config --global user.email "$EMAIL" && ssh-keyscan -H github.com >> ~/.ssh/known_hosts && touch ~/.ssh/id_ed25519.pub && touch ~/.ssh/id_ed25519 && echo "$SSHKEY1" > ~/.ssh/id_ed25519.pub && echo "$SSHKEY2" > ~/.ssh/id_ed25519 && sudo chmod 400 ~/.ssh/* && ssh-keygen -R $(curl ifconfig.me)
  setup_script:
    - apt install zip unzip android-tools-mkbootimg bc bison build-essential ca-certificates cpio curl flex git kmod libssl-dev libtinfo5 python2 sudo unzip wget xz-utils -y --no-install-recommends
    - ln -sf python2.7 /usr/bin/python
    - wget https://raw.githubusercontent.com/LineageOS/android_system_core/lineage-17.1/mkbootimg/mkbootimg.py -O /usr/bin/mkbootimg
  directory_script:
    - git clone -b halium-11.0 --single-branch --depth="1" https://github.com/dopaemon/ubports-sweet.git /tmp/ci/UBPorts/xiaomi-sweet
  kernel_script:
    - cd /tmp/ci/UBPorts/xiaomi-sweet
    - git clone https://gitlab.com/ubports/community-ports/halium-generic-adaptation-build-tools -b halium-11 build
    - chmod +x build/build.sh
    - ./build/build.sh
    - ls out
